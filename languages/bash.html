<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Bash - notes</title>


        <!-- Custom HTML head -->

        <meta name="description" content="The collection of notes, snippets and reminders about tools I&#x27;ve had experience with">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/mdbook-admonish.css">
        <link rel="stylesheet" href="../theme/pagetoc.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/swivelmargarita/notes" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <h1 id="bash"><a class="header" href="#bash">Bash</a></h1>
<h3 id="group-commands-without-subshell-with-"><a class="header" href="#group-commands-without-subshell-with-">Group commands without subshell with '{}'</a></h3>
<p>Following command does not do the result one might expect. Regardless of the exit
status of the <code>cd /tmp</code>, <code>exit</code> command will always be run.</p>
<pre><code class="language-bash">cd /tmp || echo "cd to /tmp failed"; exit
# Exits anyways even if cd was succesful
</code></pre>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="#admonition-note"></a>
</div>
<div>
<p>In <code>bash</code> you may treat <code>;</code> as an equilent of a newline.</p>
</div>
</div>
<div id="admonition-note-1" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-1-title">
<div class="admonition-title">
<div id="admonition-note-1-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="#admonition-note-1"></a>
</div>
<div>
<p>Use <code>{ cmds }</code> to group a list of commands that will be executed in the current
shell. At the other hand, <code>( cmds )</code> will execute the <code>cmds</code> in a subshell.</p>
</div>
</div>
<h4 id="dont-forget-the-"><a class="header" href="#dont-forget-the-">Don't forget the <code>;</code></a></h4>
<pre><code class="language-bash">$ bash
$ cd /tmp || { echo "cd to /tmp failed"; exit }
&gt;
&gt;
&gt;
&gt; ^C
$
</code></pre>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="#admonition-warning"></a>
</div>
<div>
<p>When using command grouping with curly braces '{', always end the list of
commands inside the curly braces with a semicolon and a space ';&lt;space&gt;' like
this:</p>
<pre><code class="language-bash">$ cd /tmp || { echo "cd to /tmp failed"; exit; }
</code></pre>
</div>
</div>
<div id="admonition-success" class="admonition admonish-success" role="note" aria-labelledby="admonition-success-title">
<div class="admonition-title">
<div id="admonition-success-title">
<p>Success</p>
</div>
<a class="admonition-anchor-link" href="#admonition-success"></a>
</div>
<div>
<pre><code class="language-bash">$ cd /tmp || { echo "cd to /tmp failed"; exit; }
$
</code></pre>
</div>
</div>
<p>References</p>
<ul>
<li>Bash idioms, 2022</li>
</ul>
<hr />
<h3 id="output-redirection"><a class="header" href="#output-redirection">Output redirection</a></h3>
<p>When bash starts it opens three file descriptors:</p>
<ol>
<li>stdin -&gt; File descriptor(fd) 0</li>
<li>stdout -&gt; fd 1</li>
<li>stderr -&gt; fd 2</li>
</ol>
<p>Assuming your terminal is <code>/dev/tty0</code>, here is how the file descriptor table
looks like when bash starts:<br />
<img src="images/initial-fd-table.png" alt="" /></p>
<p>You can also open, close and copy file descriptors. And you can also write to
them and read from them.</p>
<h4 id="redirect-the-standard-output-of-a-command-to-a-file"><a class="header" href="#redirect-the-standard-output-of-a-command-to-a-file">Redirect the standard output of a command to a file</a></h4>
<pre><code class="language-bash">command &gt;file
</code></pre>
<p>Operator <code>&gt;</code> is the output redirection operator. Bash first tries to open the
file for writing and if it succeeds it sends the stdout of command to the newly
opened file. If it fails opening the file, the whole command fails.</p>
<div id="admonition-note-2" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-2-title">
<div class="admonition-title">
<div id="admonition-note-2-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="#admonition-note-2"></a>
</div>
<div>
<p>Writing <code>command &gt;file</code> is the same as writing <code>command 1&gt;file</code>.</p>
</div>
</div>
<p>When you write the command above, bash opens the <code>file</code> and and replaces the fd
1 with the fd that points to the file. The result is that all the standard
output gets redirected, or in anoter words, ends up being written to <code>file</code><br />
<img src="images/redirect-stdout.png" alt="" /></p>
<div id="admonition-example" class="admonition admonish-example" role="note" aria-labelledby="admonition-example-title">
<div class="admonition-title">
<div id="admonition-example-title">
<p>Example</p>
</div>
<a class="admonition-anchor-link" href="#admonition-example"></a>
</div>
<div>
<p>Redirects text "test_text" to a file:</p>
<pre><code class="language-bash">echo test_text &gt; /tmp/file
</code></pre>
</div>
</div>
<h4 id="redirect-the-standard-error-of-a-command-to-a-file"><a class="header" href="#redirect-the-standard-error-of-a-command-to-a-file">Redirect the standard error of a command to a file</a></h4>
<pre><code class="language-bash">command 2&gt; file
</code></pre>
<p>Here bash redirects stderr to file:<br />
<img src="images/redirect-stderr.png" alt="" /><br />
Bash opens <code>file</code> for writing, replaces fd 2 with th fd of <code>file</code>.
Effectively, anything written to the stderr gets redirected to the <code>file</code>.</p>
<h4 id="redirect-both-standard-output-and-standard-error-to-a-file"><a class="header" href="#redirect-both-standard-output-and-standard-error-to-a-file">Redirect both standard output and standard error to a file</a></h4>
<pre><code class="language-bash">command &amp;&gt;file
</code></pre>
<p><code>&amp;&gt;</code> operator redirects both stdout and sterr of the <code>command</code> to <code>file</code>.
This is bash's shortcut for quickly redirecting both streams to the same
destination.<br />
Here is how the file descriptor table looks like after bash has redirected both
streams:<br />
<img src="images/redirect-stdout-stderr.png" alt="" /></p>
<div id="admonition-example-1" class="admonition admonish-example" role="note" aria-labelledby="admonition-example-1-title">
<div class="admonition-title">
<div id="admonition-example-1-title">
<p>Example</p>
</div>
<a class="admonition-anchor-link" href="#admonition-example-1"></a>
</div>
<div>
<p>Here we're trying to check if we've installed <code>trash-cli</code> package. And set
variable if so.<br />
If we don't have the binary <code>trash</code>, it will give <code>command not found</code>
error:</p>
<pre><code class="language-bash">$ trash -h &amp;&amp; export NNN_TRASH=1

bash: trash: command not found
</code></pre>
<p>We can redirect stderr and stdout like this:</p>
<pre><code class="language-bash">$ trash -h &amp;&gt;/dev/null &amp;&amp; export NNN_TRASH=1
$
</code></pre>
<p>or</p>
<pre><code class="language-bash">$ trash -h&gt;/dev/null 2&amp;&gt;1 &amp;&amp; export NNN_TRASH=1
$
</code></pre>
</div>
</div>
<p style="font-size:1.3em">Another way to redirect both streams to the same destination:</p>  
<pre><code class="language-bash">command &gt;file 2&gt;&amp;1
# Same as command 1&gt;file 2&gt;&amp;1
</code></pre>
<p>First, bash opens the file <code>file</code> for writing. And then reassigns file
descriptor 1 to point to that file. Effectively command <code>command</code>'s
stdout(remember that stdout's fd is 1) gets written to <code>file</code>.</p>
<p>We didn't see the <code>&gt;&amp;</code> syntax, that is <a href="https://www.gnu.org/software/bash/manual/html_node/Redirections.html#Duplicating-File-Descriptors">file descriptor
duplication</a>.</p>
<div id="admonition-quote" class="admonition admonish-quote" role="note" aria-labelledby="admonition-quote-title">
<div class="admonition-title">
<div id="admonition-quote-title">
<p>Quote</p>
</div>
<a class="admonition-anchor-link" href="#admonition-quote"></a>
</div>
<div>
<pre><code class="language-c">int dup2(int fd1, int fd2);
</code></pre>
<p>Returns a file descriptor with the value fd2. fd2 now refers to the same file
as fd1, and the file that was previously referred to by fd2 is closed.</p>
<p>...</p>
<p>If successful, dup2() returns fd2.</p>
<p>- <a href="https://www.ibm.com/docs/en/zos/3.1.0?topic=functions-dup2-duplicate-open-file-descriptor-another">https://www.ibm.com/docs/en/zos/3.1.0?topic=functions-dup2-duplicate-open-file-descriptor-another</a></p>
</div>
</div>
<p>Under the hood <code>2&gt;&amp;1</code> redirection operation calls <code>dup2()</code> two times:</p>
<pre><code class="language-bash">$ strace --follow-forks bash -c 'ls &gt;file 2&gt;&amp;1' 2&gt;&amp;1 | rg dup2

[pid 70318] dup2(3, 1)                  = 1
[pid 70318] dup2(1, 2)                  = 2
</code></pre>
<!-- ![FD timeline for 2>&1](images/fd-timeline.gif) -->
<p>System call <code>dup2(3,1)</code> was made. File descriptor 1 duplicated onto the 3. I
like think this as "move fd 1 to the whatever file that fd 3 points to". Since
fd 3 points to the <code>file</code>, stdout(file descriptor 1) is now redirected to the <code>file</code>(fd 3).</p>
<p><img src="images/after-dup2(3,1).png" alt="fd table after dup2(3,1)" /></p>
<p>After second syscall <code>dup2(1, 2)</code> fd table looks like this:<br />
<img src="images/after-dup2(1,2).png" alt="fd table after dup2(1,2)" /><br />
Fd 2 now points to the file that fd1 points, which is <code>file</code>.</p>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="#admonition-tip"></a>
</div>
<div>
<p style="font-size:1.3em">A mental model</p>
It is important to know how `command >file 2>&1` works but you can think like
this for remembering easily:  
<ul>
<li><code>&gt;file</code> is a shortcut to the <code>1&gt;file</code></li>
<li><code>n&gt;file</code> redirects output of the file desriptor with the number <code>n</code> to the file <code>file</code></li>
<li>If you want to redirect output of a file descriptor to the another file descriptor, use <code>n&gt;&amp;m</code></li>
</ul>
</div>
</div>
<p>References</p>
<ul>
<li>https://catonmat.net/bash-one-liners-explained-part-three</li>
<li>https://pubs.opengroup.org/onlinepubs/9799919799/utilities/V3_chap02.html#tag_19_07</li>
<li>https://www.gnu.org/software/bash/manual/html_node/Redirections.html</li>
</ul>
<hr />

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../languages/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../languages/python.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../languages/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../languages/python.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../theme/pagetoc.js"></script>


    </div>
    </body>
</html>
